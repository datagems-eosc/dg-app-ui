name: Code Metrics

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop, staging]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  NODE_ENV: development
  CI: true

jobs:
  metrics:
    name: Calculate Code Metrics
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "pnpm"

      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          pnpm install --frozen-lockfile
          echo "âœ… Dependencies installed"

      - name: Install code metrics tools
        run: |
          pnpm add -D complexity-report plato

      - name: Calculate code complexity
        run: |
          echo "ðŸ“Š Calculating code complexity metrics..."
          npx complexity-report --format json --output complexity-report.json src/ || true
          echo "âœ… Complexity report generated"

      - name: Generate code metrics with Plato
        run: |
          echo "ðŸ“ˆ Generating detailed code metrics..."
          npx plato -r -d plato-report -t "DataGEMS Frontend" -l .eslintrc.json src/ || true
          echo "âœ… Plato report generated"

      - name: Count lines of code
        run: |
          echo "ðŸ“ Counting lines of code..."
          echo "## Code Metrics Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Lines of Code" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find src -name "*.ts" -o -name "*.tsx" | xargs wc -l | tail -1 >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### TypeScript Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find src -name "*.ts" -o -name "*.tsx" | wc -l >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload complexity report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: complexity-report
          path: complexity-report.json
          retention-days: 30

      - name: Upload plato report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: plato-report
          path: plato-report/
          retention-days: 30
